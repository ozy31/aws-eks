apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-db
  labels:
    app: postgres-db
    tags.datadoghq.com/env: "production"
    tags.datadoghq.com/service: "my-postgres"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-db
  template:
    metadata:
      labels:
        app: postgres-db
        tags.datadoghq.com/env: "production"
        tags.datadoghq.com/service: "my-postgres"
      annotations:
        # --- DATADOG DATABASE MONITORING ---
        # Agent'a bu pod'un bir Postgres DB olduğunu ve nasıl bağlanacağını söylüyoruz.
        # Not: Gerçek hayatta şifreler buraya açık yazılmaz (Secret kullanılır),
        # ama demo için kabul edilebilir.
        ad.datadoghq.com/postgres-db.check_names: '["postgres"]'
        ad.datadoghq.com/postgres-db.init_configs: '[{}]'
        ad.datadoghq.com/postgres-db.instances: |
          [
            {
              "host": "%%host%%",
              "port": 5432,
              "username": "datadog", 
              "password": "datadogpassword",
              "dbname": "postgres",
              "ssl": "disable"
            }
          ]
    spec:
      containers:
      - name: postgres-db
        image: postgres:15
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          value: "change_me_in_production"
        # Başlangıç scripti ile datadog kullanıcısını oluşturacağız
        # Bunu ConfigMap ile mount etmek daha temiz olurdu ama şimdilik manuel yapacağız
        # veya video sırasında exec ile girip oluşturacağız.
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-db
spec:
  selector:
    app: postgres-db
  ports:
    - protocol: TCP
      port: 5432
      targetPort: 5432

